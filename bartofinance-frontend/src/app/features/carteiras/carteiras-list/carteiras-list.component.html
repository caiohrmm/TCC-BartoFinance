<div class="min-h-screen bg-gray-50 dark:bg-slate-950 flex flex-col">
  <!-- Header/Navbar -->
  <nav class="bg-white dark:bg-slate-900 shadow-sm border-b border-gray-200 dark:border-slate-700">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-20">
        <div class="flex items-center">
          <img
            src="assets/logo.png"
            alt="BartoFinance"
            class="h-16 w-auto hover:opacity-80 transition-opacity cursor-pointer"
            routerLink="/dashboard"
          />
        </div>
        <div class="hidden md:flex items-center space-x-8">
          <a
            routerLink="/dashboard"
            class="text-gray-600 dark:text-gray-400 hover:text-primary-600 transition"
            >Dashboard</a
          >
          <a
            routerLink="/investidores"
            class="text-gray-600 dark:text-gray-400 hover:text-primary-600 transition"
            >Investidores</a
          >
          <a
            routerLink="/carteiras"
            class="text-gray-900 dark:text-gray-100 hover:text-primary-600 font-medium transition"
            >Carteiras</a
          >
        </div>
        <div class="flex items-center space-x-4">
          <span class="text-sm text-gray-700 dark:text-gray-300"
            >Olá, <span class="font-semibold">{{ userName() }}</span></span
          >
          <button (click)="abrirModalLogout()" class="btn-ghost text-sm">
            Sair
          </button>
        </div>
      </div>
    </div>
  </nav>

  <main class="flex-1 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">
    <!-- Cabeçalho -->
    <div class="flex justify-between items-center mb-6 animate-fade-in">
      <div>
        <h2 class="text-3xl font-bold text-gray-900 dark:text-gray-100 mb-1">
          Carteiras de Investimento
        </h2>
        <p class="text-gray-600 dark:text-gray-400">Gerencie as carteiras dos seus clientes</p>
      </div>
      <div class="flex gap-3">
        <button (click)="abrirModal()" class="btn-primary flex items-center">
          <span class="mr-2">➕</span> Nova Carteira
        </button>
      </div>
    </div>

    <!-- Filtros de Risco -->
    <div class="mb-6 animate-slide-up">
      <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">
        Filtrar por Risco
      </h3>
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
        <button
          (click)="aplicarFiltroRisco('')"
          [class]="
            filtroRisco() === '' && filtroTipo() === ''
              ? 'card bg-primary-50 border-primary-300 border-2'
              : 'card hover:bg-gray-100 cursor-pointer'
          "
        >
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">Todas</p>
              <p class="text-2xl font-bold text-gray-900 dark:text-gray-100">
                {{ todasCarteiras().length }}
              </p>
            </div>
            <div class="text-3xl">💼</div>
          </div>
        </button>

        @for (risco of riscoOptions; track risco.value) {
        <button
          (click)="aplicarFiltroRisco(risco.value)"
          [class]="
            filtroRisco() === risco.value
              ? 'card bg-' +
                risco.color +
                '-50 border-' +
                risco.color +
                '-300 border-2'
              : 'card hover:bg-gray-100 cursor-pointer'
          "
        >
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">
                {{ risco.label }}
              </p>
              <p class="text-2xl font-bold text-gray-900 dark:text-gray-100">
                {{ contarPorRisco(risco.value) }}
              </p>
            </div>
            <div class="text-3xl">{{ risco.icon }}</div>
          </div>
        </button>
        }
      </div>
    </div>

    <!-- Filtros de Tipo -->
    <div class="mb-8 animate-slide-up animation-delay-200">
      <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">Filtrar por Tipo</h3>
      <div class="grid grid-cols-2 gap-4">
        @for (tipo of tipoOptions; track tipo.value) {
        <button
          (click)="aplicarFiltroTipo(tipo.value)"
          [class]="
            filtroTipo() === tipo.value
              ? 'card bg-purple-50 border-purple-300 border-2'
              : 'card hover:bg-gray-100 cursor-pointer'
          "
        >
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">
                {{ tipo.label }}
              </p>
              <p class="text-2xl font-bold text-gray-900 dark:text-gray-100">
                {{ contarPorTipo(tipo.value) }}
              </p>
            </div>
            <div class="text-3xl">{{ tipo.icon }}</div>
          </div>
        </button>
        }
      </div>
    </div>

    @if (filtroRisco() !== '' || filtroTipo() !== '') {
    <div class="mb-6">
      <button
        (click)="limparFiltros()"
        class="text-sm text-primary-600 hover:text-primary-800 flex items-center"
      >
        <span class="mr-1">✕</span> Limpar Filtros
      </button>
    </div>
    }

    <!-- Tabela de Carteiras -->
    <div class="card">
      @if (loading()) {
      <div class="flex justify-center items-center py-8">
        <span
          class="animate-spin rounded-full h-12 w-12 border-4 border-primary-500 border-t-transparent"
        ></span>
        <p class="ml-4 text-primary-600">Carregando carteiras...</p>
      </div>
      } @else if (carteiras().length === 0) {
      <div class="text-center py-8 text-gray-500">
        <p class="text-4xl mb-4">📂</p>
        <p class="text-lg font-medium">Nenhuma carteira encontrada.</p>
        <p class="text-sm mt-2">
          Comece criando uma nova carteira de investimentos.
        </p>
        <div class="flex justify-center gap-4 mt-6">
          <button (click)="limparFiltros()" class="btn-secondary">
            Limpar Filtros
          </button>
          <button (click)="abrirModal()" class="btn-primary">
            Criar Primeira Carteira
          </button>
        </div>
      </div>
      } @else {
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th
                scope="col"
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
              >
                Nome
              </th>
              <th
                scope="col"
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
              >
                Tipo / Risco
              </th>
              <th
                scope="col"
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
              >
                Investidor
              </th>
              <th
                scope="col"
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
              >
                Rentabilidade
              </th>
              <th
                scope="col"
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
              >
                Valor Total
              </th>
              <th
                scope="col"
                class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider"
              >
                Ações
              </th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            @for (carteira of carteiras(); track carteira.id) {
            <tr class="hover:bg-gray-50 transition-colors">
              <td class="px-6 py-4 whitespace-nowrap">
                <div>
                  <div class="text-sm font-medium text-gray-900">
                    {{ carteira.nome }}
                  </div>
                  <div class="text-sm text-gray-500">
                    {{ carteira.descricao || "Sem descrição" }}
                  </div>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex flex-col gap-1">
                  @if (getTipoInfo(carteira.tipo); as tipoInfo) {
                  <span class="badge bg-purple-100 text-purple-800">
                    {{ tipoInfo.icon }} {{ tipoInfo.label }}
                  </span>
                  } @if (getRiscoInfo(carteira.risco); as riscoInfo) {
                  <span
                    [class]="
                      'badge bg-' +
                      riscoInfo.color +
                      '-100 text-' +
                      riscoInfo.color +
                      '-800'
                    "
                  >
                    {{ riscoInfo.icon }} {{ riscoInfo.label }}
                  </span>
                  }
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">
                  {{ getInvestidorNome(carteira.investidorId) }}
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm">
                  <div class="text-gray-900 font-medium">
                    Atual: {{ formatarPercentual(carteira.rentabilidadeAtual) }}
                  </div>
                  <div class="text-gray-500">
                    Meta: {{ formatarPercentual(carteira.metaRentabilidade) }}
                  </div>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900">
                  {{ formatarValor(carteira.valorTotal) }}
                </div>
              </td>
              <td
                class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"
              >
                <a
                  [routerLink]="['/carteiras', carteira.id]"
                  class="text-blue-600 hover:text-blue-900 mr-4"
                  title="Ver Detalhes"
                >
                  👁️
                </a>
                <button
                  (click)="abrirModal(carteira)"
                  class="text-primary-600 hover:text-primary-900 mr-4"
                  title="Editar"
                >
                  ✏️
                </button>
                <button
                  (click)="abrirModalExclusao(carteira)"
                  class="text-red-600 hover:text-red-900"
                  title="Excluir"
                >
                  🗑️
                </button>
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>
      }
    </div>
  </main>

  <!-- Modal de Criação/Edição -->
  @if (showModal()) {
  <div
    class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 animate-fade-in"
  >
    <div
      class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto animate-slide-up"
    >
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-gray-900">
          {{ isEditing() ? "Editar Carteira" : "Nova Carteira" }}
        </h3>
        <button
          (click)="fecharModal()"
          class="text-gray-400 hover:text-gray-600"
        >
          ✕
        </button>
      </div>

      <form [formGroup]="carteiraForm" (ngSubmit)="salvarCarteira()">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <!-- Nome -->
          <div class="md:col-span-2">
            <label class="label" for="nome">Nome da Carteira *</label>
            <input
              id="nome"
              type="text"
              formControlName="nome"
              class="input"
              placeholder="Ex: Carteira Conservadora 2025"
            />
            @if (carteiraForm.get('nome')?.invalid &&
            carteiraForm.get('nome')?.touched) {
            <p class="text-red-600 text-sm mt-1">
              Nome é obrigatório (3-100 caracteres)
            </p>
            }
          </div>

          <!-- Descrição -->
          <div class="md:col-span-2">
            <label class="label" for="descricao">Descrição (Opcional)</label>
            <textarea
              id="descricao"
              formControlName="descricao"
              class="input"
              rows="2"
              placeholder="Descreva brevemente esta carteira..."
            ></textarea>
            @if (carteiraForm.get('descricao')?.invalid &&
            carteiraForm.get('descricao')?.touched) {
            <p class="text-red-600 text-sm mt-1">Máximo 500 caracteres</p>
            }
          </div>

          <!-- Tipo -->
          <div>
            <label class="label" for="tipo">Tipo de Carteira *</label>
            <select id="tipo" formControlName="tipo" class="input">
              <option value="" disabled>Selecione o tipo</option>
              @for (tipo of tipoOptions; track tipo.value) {
              <option [value]="tipo.value">
                {{ tipo.icon }} {{ tipo.label }} - {{ tipo.description }}
              </option>
              }
            </select>
            @if (carteiraForm.get('tipo')?.invalid &&
            carteiraForm.get('tipo')?.touched) {
            <p class="text-red-600 text-sm mt-1">Tipo é obrigatório</p>
            }
          </div>

          <!-- Risco -->
          <div>
            <label class="label" for="risco">Nível de Risco *</label>
            <select id="risco" formControlName="risco" class="input">
              <option value="" disabled>Selecione o risco</option>
              @for (risco of riscoOptions; track risco.value) {
              <option [value]="risco.value">
                {{ risco.icon }} {{ risco.label }} - {{ risco.description }}
              </option>
              }
            </select>
            @if (carteiraForm.get('risco')?.invalid &&
            carteiraForm.get('risco')?.touched) {
            <p class="text-red-600 text-sm mt-1">Risco é obrigatório</p>
            }
          </div>

          <!-- Meta de Rentabilidade -->
          <div>
            <label class="label" for="metaRentabilidade"
              >Meta de Rentabilidade (%) *</label
            >
            <input
              id="metaRentabilidade"
              type="number"
              formControlName="metaRentabilidade"
              class="input"
              placeholder="Ex: 12.5"
              step="0.01"
              min="0"
              max="100"
            />
            @if (carteiraForm.get('metaRentabilidade')?.invalid &&
            carteiraForm.get('metaRentabilidade')?.touched) {
            <p class="text-red-600 text-sm mt-1">
              Meta deve estar entre 0% e 100%
            </p>
            }
          </div>

          <!-- Investidor -->
          <div>
            <label class="label" for="investidorId">
              Investidor @if (carteiraForm.get('tipo')?.value ===
              'PERSONALIZADA') {
              <span class="text-red-600">*</span>
              }
            </label>
            @if (carteiraForm.get('tipo')?.value === 'MODELO') {
            <input
              type="text"
              class="input bg-gray-100 cursor-not-allowed"
              value="Nenhum (carteira modelo)"
              disabled
              readonly
            />
            <p class="text-xs text-gray-500 mt-1">
              💡 Carteiras MODELO não são vinculadas a investidores
            </p>
            } @else {
            <select
              id="investidorId"
              formControlName="investidorId"
              class="input"
            >
              <option value="" disabled selected>
                Selecione um investidor
              </option>
              @for (investidor of investidores(); track investidor.id) {
              <option [value]="investidor.id">
                {{ investidor.nome }} ({{ investidor.cpf }})
              </option>
              }
            </select>
            @if (carteiraForm.get('investidorId')?.invalid &&
            carteiraForm.get('investidorId')?.touched) {
            <p class="text-red-600 text-sm mt-1">
              Selecione um investidor para carteira PERSONALIZADA
            </p>
            } }
          </div>
        </div>

        <div class="flex justify-end space-x-4 mt-6">
          <button type="button" (click)="fecharModal()" class="btn-secondary">
            Cancelar
          </button>
          <button
            type="submit"
            class="btn-primary"
            [disabled]="loading() || carteiraForm.invalid"
          >
            {{ isEditing() ? "Salvar Alterações" : "Criar Carteira" }}
          </button>
        </div>
      </form>
    </div>
  </div>
  }

  <!-- Footer -->
  <app-footer></app-footer>

  <!-- Modal de Confirmação de Exclusão -->
  <app-confirm-modal
    [show]="showDeleteModal()"
    [title]="'Excluir Carteira'"
    [message]="
      'Tem certeza que deseja excluir a carteira ' +
      (carteiraToDelete()?.nome || '') +
      '? Esta ação não pode ser desfeita e todos os dados relacionados serão perdidos.'
    "
    [confirmText]="'Excluir'"
    [cancelText]="'Cancelar'"
    [type]="'danger'"
    [icon]="'🗑️'"
    (confirm)="confirmarExclusao()"
    (cancel)="cancelarExclusao()"
  ></app-confirm-modal>

  <!-- Modal de Confirmação de Logout -->
  <app-confirm-modal
    [show]="showLogoutModal()"
    [title]="'Sair do Sistema'"
    [message]="
      'Você deseja realmente sair do sistema? Você precisará fazer login novamente para acessar.'
    "
    [confirmText]="'Sair'"
    [cancelText]="'Cancelar'"
    [type]="'warning'"
    [icon]="'👋'"
    (confirm)="confirmarLogout()"
    (cancel)="cancelarLogout()"
  ></app-confirm-modal>
</div>
