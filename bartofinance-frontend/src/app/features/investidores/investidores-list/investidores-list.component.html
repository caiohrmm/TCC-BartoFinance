<div class="min-h-screen bg-gray-50 dark:bg-slate-950 flex flex-col">
  <!-- Header/Navbar -->
  <nav class="bg-white dark:bg-slate-900 shadow-sm border-b border-gray-200 dark:border-slate-700">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-20">
        <div class="flex items-center">
          <img 
            src="assets/logo.png" 
            alt="BartoFinance" 
            class="h-12 w-auto hover:opacity-80 transition-opacity cursor-pointer" 
            routerLink="/dashboard"
          />
        </div>
        <div class="hidden md:flex items-center space-x-8">
          <a routerLink="/dashboard" class="text-gray-600 dark:text-gray-400 hover:text-primary-600 transition">Dashboard</a>
          <a routerLink="/investidores" class="text-gray-900 dark:text-gray-100 hover:text-primary-600 font-medium transition">Investidores</a>
          <a routerLink="/carteiras" class="text-gray-600 dark:text-gray-400 hover:text-primary-600 transition">Carteiras</a>
        </div>
        <div class="flex items-center space-x-4">
          <span class="text-sm text-gray-700 dark:text-gray-300">Ol√°, <span class="font-semibold">{{ userName() }}</span></span>
          <button (click)="abrirModalLogout()" class="btn-ghost text-sm">Sair</button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="flex-1 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">
    <!-- Header Section -->
    <div class="mb-8">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100 mb-2">Investidores</h1>
          <p class="text-gray-600 dark:text-gray-400">Gerencie sua carteira de clientes</p>
        </div>
        <button (click)="abrirModal()" class="btn-primary">
          <span class="text-xl mr-2">+</span>
          Novo Investidor
        </button>
      </div>
    </div>

    <!-- Filtros e Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <!-- Filtro Todos -->
      <button 
        (click)="aplicarFiltro('')"
        [class]="filtroPerfil() === '' ? 'card bg-primary-50 border-primary-300 border-2' : 'card hover:bg-gray-100 cursor-pointer'"
      >
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">Todos</p>
            <p class="text-2xl font-bold text-gray-900 dark:text-gray-100">{{ todosInvestidores().length }}</p>
          </div>
          <div class="text-3xl">üë•</div>
        </div>
      </button>

      <!-- Filtro por Perfil -->
      @for (perfil of perfilOptions; track perfil.value) {
        <button 
          (click)="aplicarFiltro(perfil.value)"
          [class]="filtroPerfil() === perfil.value ? 'card bg-' + perfil.color + '-50 border-' + perfil.color + '-300 border-2' : 'card hover:bg-gray-100 cursor-pointer'"
        >
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">{{ perfil.label }}</p>
              <p class="text-2xl font-bold text-gray-900 dark:text-gray-100">
                {{ contarPorPerfil(perfil.value) }}
              </p>
            </div>
            <div class="text-3xl">{{ perfil.icon }}</div>
          </div>
        </button>
      }
    </div>

    <!-- Tabela de Investidores -->
    <div class="card">
      @if (loading()) {
        <div class="flex justify-center items-center py-12">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600"></div>
        </div>
      } @else if (investidores().length === 0) {
        <div class="text-center py-12">
          <div class="text-6xl mb-4">üìä</div>
          <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2">Nenhum investidor encontrado</h3>
          <p class="text-gray-600 dark:text-gray-400 mb-4">Comece adicionando seu primeiro cliente</p>
          <button (click)="abrirModal()" class="btn-primary">
            Adicionar Investidor
          </button>
        </div>
      } @else {
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50 dark:bg-slate-800">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Cliente</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Contato</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Perfil</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Patrim√¥nio</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Renda Mensal</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">A√ß√µes</th>
              </tr>
            </thead>
            <tbody class="bg-white dark:bg-slate-900 divide-y divide-gray-200 dark:divide-slate-700">
              @for (investidor of investidores(); track investidor.id) {
                <tr class="hover:bg-gray-50 dark:hover:bg-slate-800 transition">
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                      <div class="flex-shrink-0 h-10 w-10 bg-primary-100 rounded-full flex items-center justify-center">
                        <span class="text-primary-700 font-semibold text-sm">
                          {{ investidor.nome.charAt(0).toUpperCase() }}
                        </span>
                      </div>
                      <div class="ml-4">
                        <div class="text-sm font-medium text-gray-900 dark:text-gray-100">{{ investidor.nome }}</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">{{ formatarCPF(investidor.cpf) }}</div>
                      </div>
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900 dark:text-gray-100">{{ investidor.email }}</div>
                    <div class="text-sm text-gray-500 dark:text-gray-400">{{ formatarTelefone(investidor.telefone) }}</div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    @if (getPerfilInfo(investidor.perfilInvestidor); as perfil) {
                      <span [class]="'badge badge-' + (perfil.color === 'blue' ? 'info' : perfil.color === 'yellow' ? 'warning' : 'danger')">
                        {{ perfil.icon }} {{ perfil.label }}
                      </span>
                    }
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">
                    {{ formatarValor(investidor.patrimonioAtual) }}
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    {{ formatarValor(investidor.rendaMensal) }}
                  </td>
                      <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <a
                          [routerLink]="['/investidores', investidor.id]"
                          class="text-blue-600 hover:text-blue-900 mr-4"
                          title="Ver Perfil"
                        >
                          üëÅÔ∏è
                        </a>
                        <button
                          (click)="abrirModal(investidor)"
                          class="text-primary-600 hover:text-primary-900 mr-4"
                          title="Editar"
                        >
                          ‚úèÔ∏è
                        </button>
                        <button
                          (click)="abrirModalExclusao(investidor)"
                          class="text-red-600 hover:text-red-900"
                          title="Excluir"
                        >
                          üóëÔ∏è
                        </button>
                      </td>
                    </tr>
              }
            </tbody>
          </table>
        </div>
      }
    </div>
  </main>

  <!-- Modal -->
  @if (showModal()) {
    <div class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4" (click)="fecharModal()">
      <div class="bg-white dark:bg-slate-900 rounded-lg shadow-xl max-w-2xl w-full animate-slide-up" (click)="$event.stopPropagation()">
        <!-- Modal Header -->
        <div class="bg-primary-600 text-white px-6 py-4 rounded-t-lg">
          <div class="flex justify-between items-center">
            <h3 class="text-xl font-bold">
              {{ isEditing() ? 'Editar Investidor' : 'Novo Investidor' }}
            </h3>
            <button (click)="fecharModal()" class="text-white hover:text-gray-200 text-2xl">√ó</button>
          </div>
        </div>

        <!-- Modal Body -->
        <form [formGroup]="investidorForm" (ngSubmit)="salvarInvestidor()" class="p-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Nome -->
            <div class="md:col-span-2">
              <label class="label" for="nome">Nome Completo *</label>
              <input id="nome" type="text" formControlName="nome" class="input" placeholder="Nome do investidor">
              @if (investidorForm.get('nome')?.invalid && investidorForm.get('nome')?.touched) {
                <p class="text-red-600 text-sm mt-1">Nome √© obrigat√≥rio (m√≠nimo 3 caracteres)</p>
              }
            </div>

            <!-- CPF -->
            <div>
              <label class="label" for="cpf">CPF *</label>
              <input 
                id="cpf" 
                type="text" 
                formControlName="cpf" 
                class="input" 
                placeholder="000.000.000-00"
                appCpfMask
                maxlength="14"
              >
              @if (investidorForm.get('cpf')?.invalid && investidorForm.get('cpf')?.touched) {
                <p class="text-red-600 text-sm mt-1">
                  @if (investidorForm.get('cpf')?.errors?.['required']) {
                    CPF √© obrigat√≥rio
                  } @else if (investidorForm.get('cpf')?.errors?.['pattern']) {
                    CPF deve conter 11 d√≠gitos
                  } @else if (investidorForm.get('cpf')?.errors?.['cpfInvalid']) {
                    CPF inv√°lido
                  }
                </p>
              }
              <p class="text-xs text-gray-500 mt-1">
                <strong>Formato:</strong> 000.000.000-00 (ser√° validado automaticamente)
              </p>
            </div>

            <!-- Telefone -->
            <div>
              <label class="label" for="telefone">Telefone</label>
              <input 
                id="telefone" 
                type="text" 
                formControlName="telefone" 
                class="input" 
                placeholder="(11) 99999-9999"
                appTelefoneMask
              >
              @if (investidorForm.get('telefone')?.invalid && investidorForm.get('telefone')?.touched) {
                <p class="text-red-600 text-sm mt-1">Telefone inv√°lido (10 ou 11 d√≠gitos)</p>
              }
            </div>

            <!-- Email -->
            <div class="md:col-span-2">
              <label class="label" for="email">Email</label>
              <input id="email" type="email" formControlName="email" class="input" placeholder="email@exemplo.com">
              @if (investidorForm.get('email')?.invalid && investidorForm.get('email')?.touched) {
                <p class="text-red-600 text-sm mt-1">Email inv√°lido</p>
              }
            </div>

            <!-- Perfil de Investidor -->
            <div class="md:col-span-2">
              <label class="label" for="perfilInvestidor">Perfil de Investidor *</label>
              <select id="perfilInvestidor" formControlName="perfilInvestidor" class="input">
                <option value="">Selecione um perfil</option>
                @for (perfil of perfilOptions; track perfil.value) {
                  <option [value]="perfil.value">{{ perfil.icon }} {{ perfil.label }} - {{ perfil.description }}</option>
                }
              </select>
              @if (investidorForm.get('perfilInvestidor')?.invalid && investidorForm.get('perfilInvestidor')?.touched) {
                <p class="text-red-600 text-sm mt-1">Perfil √© obrigat√≥rio</p>
              }
            </div>

            <!-- Patrim√¥nio Atual -->
            <div>
              <label class="label" for="patrimonioAtual">Patrim√¥nio Atual *</label>
              <input 
                id="patrimonioAtual" 
                type="text" 
                formControlName="patrimonioAtual" 
                class="input" 
                placeholder="R$ 0,00"
                appCurrencyMask
              >
              @if (investidorForm.get('patrimonioAtual')?.invalid && investidorForm.get('patrimonioAtual')?.touched) {
                <p class="text-red-600 text-sm mt-1">Patrim√¥nio deve ser maior ou igual a zero</p>
              }
            </div>

            <!-- Renda Mensal -->
            <div>
              <label class="label" for="rendaMensal">Renda Mensal *</label>
              <input 
                id="rendaMensal" 
                type="text" 
                formControlName="rendaMensal" 
                class="input" 
                placeholder="R$ 0,00"
                appCurrencyMask
              >
              @if (investidorForm.get('rendaMensal')?.invalid && investidorForm.get('rendaMensal')?.touched) {
                <p class="text-red-600 text-sm mt-1">Renda deve ser maior ou igual a zero</p>
              }
            </div>

            <!-- Objetivos -->
            <div class="md:col-span-2">
              <label class="label" for="objetivos">Objetivos de Investimento</label>
              <textarea id="objetivos" formControlName="objetivos" class="input" rows="3" placeholder="Descreva os objetivos..." maxlength="500"></textarea>
              @if (investidorForm.get('objetivos')?.invalid && investidorForm.get('objetivos')?.touched) {
                <p class="text-red-600 text-sm mt-1">M√°ximo de 500 caracteres</p>
              }
            </div>
          </div>

          <!-- Modal Footer -->
          <div class="flex justify-end gap-4 mt-6 pt-4 border-t">
            <button type="button" (click)="fecharModal()" class="btn-secondary">
              Cancelar
            </button>
            <button type="submit" class="btn-primary" [disabled]="loading() || investidorForm.invalid">
              @if (loading()) {
                <span class="inline-block animate-spin mr-2">‚è≥</span>
                Salvando...
              } @else {
                {{ isEditing() ? 'Atualizar' : 'Criar' }} Investidor
              }
            </button>
          </div>
        </form>
      </div>
    </div>
  }

  <!-- Footer -->
  <app-footer></app-footer>

  <!-- Modal de Confirma√ß√£o de Exclus√£o -->
  <app-confirm-modal
    [show]="showDeleteModal()"
    [title]="'Excluir Investidor'"
    [message]="'Tem certeza que deseja excluir o investidor ' + (investidorToDelete()?.nome || '') + '? Esta a√ß√£o n√£o pode ser desfeita.'"
    [confirmText]="'Excluir'"
    [cancelText]="'Cancelar'"
    [type]="'danger'"
    [icon]="'üóëÔ∏è'"
    (confirm)="confirmarExclusao()"
    (cancel)="cancelarExclusao()"
  ></app-confirm-modal>

  <!-- Modal de Confirma√ß√£o de Logout -->
  <app-confirm-modal
    [show]="showLogoutModal()"
    [title]="'Sair do Sistema'"
    [message]="'Voc√™ deseja realmente sair do sistema? Voc√™ precisar√° fazer login novamente para acessar.'"
    [confirmText]="'Sair'"
    [cancelText]="'Cancelar'"
    [type]="'warning'"
    [icon]="'üëã'"
    (confirm)="confirmarLogout()"
    (cancel)="cancelarLogout()"
  ></app-confirm-modal>
</div>
